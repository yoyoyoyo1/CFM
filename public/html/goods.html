<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <script src="../js/jQuery.js"></script>
    <script src="../js/bootstrap.js"></script>
    <script src="../js/bootstrapValidator.js"></script>
    <script src="../js/bootstrap_table.js"></script>
    <script src="../js/bootstrap.select.js"></script>
    <title>测试</title>
</head>
<style>
    .tt.table>tbody>tr>td{
            overflow: hidden;
            text-overflow:ellipsis;
            white-space: nowrap;
        }
    </style>

<body>
    <div id="navbar">
        <navbar></navbar>
    </div>
    <div style="margin-top:50px">
        <div class="row">
            <div class="col-md-3 col-sm-3">

                <div class="well sidebar-nav">
                    <ul class="nav nav-list">
                        <li class="active">
                            <a href="./index.html">财产管理</a>
                        </li>
                        <li>
                            <a href="./serach.html">物品筛选</a>
                        </li>
                        <li>
                            <a href="./admin.html">用户信息</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-md-9 col-sm-9">
                <div id="architecture">
                    <architecture></architecture>
                </div>
                <div>
                    </br>
                    <div>
                        <nav aria-label="Page navigation col-md-3 col-sm-3" class=" pull-left">
                            <ol class="breadcrumb">
                                <li>
                                    <a href="./index.html">建筑物</a>
                                </li>
                                <li>
                                    <a href="./floor.html">楼层</a>
                                </li>
                                <li>
                                    <a href="./room.html">房间 </a>
                                </li>
                                <li class="active">物品</li>
                            </ol>
                        </nav>

                        <!-- <div class="dropdown col-md-2 col-sm-2">
                            <select class="form-control" id="floors">
                                <option>全部楼层</option>
                            </select>
                        </div> -->
                        <div style="float:right">
                            <a href="#" class="tooltip-test" data-toggle="tooltip" title="默认的 Tooltip" id="where"></a>&nbsp;&nbsp;&nbsp;
                        </div>


                    </div>
                    </br>
                    </br>
                    </br>

                </div>
                <div class="modal fade" id="plusProperty" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="createFileTitle">增加物品</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div>

                                    <div class="form-group">
                                        <label for="fileName" class="col-form-label">编号</label>
                                        <input type="text" autofocus class="form-control" id="index">
                                    </div>
                                    <div class="form-group">
                                        <label for="fileName" class="col-form-label">名称</label>
                                        <input type="text" autofocus class="form-control" id="name">
                                    </div>
                                    <div class="form-group">
                                        <label for="fileName" class="col-form-label">数量</label>
                                        <input type="text" autofocus class="form-control" id="num">
                                    </div>
                                    <div class="form-group">
                                        <label for="fileName" class="col-form-label">单价</label>
                                        <input type="text" autofocus class="form-control" id="price">
                                    </div>
                                    <div class="form-group">
                                        <label for="fileName" class="col-form-label">添置时间</label>
                                        <input type="text" autofocus class="form-control" id="createTime">
                                    </div>
                                    <div class="form-group">
                                        <label for="fileName" class="col-form-label">注销时间</label>
                                        <input type="text" autofocus class="form-control" id="deleteTime">
                                    </div>
                                    <div class="form-group">
                                        <label for="fileName" class="col-form-label">管理员</label>
                                        <input type="text" autofocus class="form-control" id="admin">
                                    </div>
                                    <div class="form-group">
                                        <label for="fileName" class="col-form-label">备注</label>
                                        <textarea type="text" autofocus class="form-control" id="mark" style="word-break:break-all; word-wrap:break-all;"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" id="createSure">确定</button>
                                <button type="button" class="btn btn-default" id="createNo">取消</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="editProperty" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="createFileTitle">修改物品
                                </h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div>
                                    <div class="form-group">
                                        <label for="fileName" class="col-form-label">编号</label>
                                        <input type="text" autofocus class="form-control" id="indexEdit">
                                    </div>
                                    <div class="form-group">
                                        <label for="fileName" class="col-form-label">名称</label>
                                        <input type="text" autofocus class="form-control" id="nameEdit">
                                    </div>
                                    <div class="form-group">
                                        <label for="fileName" class="col-form-label">数量</label>
                                        <input type="text" autofocus class="form-control" id="numEdit">
                                    </div>
                                    <div class="form-group">
                                        <label for="fileName" class="col-form-label">单价</label>
                                        <input type="text" autofocus class="form-control" id="priceEdit">
                                    </div>
                                    <div class="form-group">
                                        <label for="fileName" class="col-form-label">添置时间</label>
                                        <input type="text" autofocus class="form-control" id="createTimeEdit">
                                    </div>
                                    <div class="form-group">
                                        <label for="fileName" class="col-form-label">注销时间</label>
                                        <input type="text" autofocus class="form-control" id="deleteTimeEdit">
                                    </div>
                                    <div class="form-group">
                                        <label for="fileName" class="col-form-label">管理员</label>
                                        <input type="text" autofocus class="form-control" id="adminEdit">
                                    </div>
                                    <div class="form-group">
                                        <label for="fileName" class="col-form-label">备注</label>
                                        <textarea type="text" autofocus class="form-control" id="markEdit" style="word-break:break-all; word-wrap:break-all;"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" id="editSure">确定</button>
                                <button type="button" class="btn btn-default" id="editNo">取消</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <div id="toolbar" class="btn-group">
                        <button id="plus" type="button" class="btn btn-primary">
                            <i class="glyphicon glyphicon-plus"></i>
                            <span>增加</span>
                        </button>
                        <button id="fix" type="button" class="btn btn-success">
                            <i class="glyphicon glyphicon-edit"></i>
                            <span>修改</span>
                        </button>
                        <button id="delete" type="button" class="btn btn-danger">
                            <i class="glyphicon glyphicon-trash"></i>
                            <span>删除</span>
                        </button>
                        <button onclick="downloadExl()" id="export" class="btn btn-info">
                            <i class="glyphicon glyphicon-download-alt"></i>
                            <span>导出</span>
                        </button>
                    </div>
                    <table id="table" class="tt" style="table-layout: fixed">
                        <thead>
                            <tr>
                                <th data-field="state" data-checkbox="true"></th>
                                <th data-field="index">编号</th>
                                <th data-field="name">名称</th>
                                <th data-field="num">数量</th>
                                <th data-field="price">单价</th>
                                <th data-field="total">金额</th>
                                <th data-field="createTime">添置时间</th>
                                <th data-field="deleteTime">注销时间</th>
                                <th data-field="admin">保管人</th>
                                <th data-field="mark" data-switchable="false">备注</th>
                            </tr>
                        </thead>
                    </table>
                </div>


            </div>
        </div>
    </div>

</body>
<script src="../js/vue.js"></script>
<script src="./js/navbar.js"></script>
<script src="./js/goods.js"></script>
<script>
    let XLSX = require('xlsx')

    function saveAs(obj, fileName) { //当然可以自定义简单的下载文件实现方式 

        var tmpa = document.createElement("a");
        tmpa.download = fileName || "下载";
        tmpa.href = URL.createObjectURL(obj); //绑定a标签

        tmpa.click(); //模拟点击实现下载
        setTimeout(function () { //延时释放
            URL.revokeObjectURL(obj); //用URL.revokeObjectURL()来释放这个object URL
            alert("导出成功")
        }, 100);


    }
    const wopts = {
        bookType: 'xlsx',
        bookSST: false,
        type: 'binary'
    }; //这里的数据是用来定义导出的格式类型
    function fix(data) {
        var tableHead = ["编号", "名称", "数量", "单价", "金额", "添置时间", "注销时间", "保管人", "备注"]
        var architecture = JSON.parse(window.localStorage.getItem("architecture"))
        var floor = JSON.parse(window.localStorage.getItem("floor"))
        var room = JSON.parse(window.localStorage.getItem('room'))
        var map = {
            "编号": "index",
            "名称": "name",
            "数量": "num",
            "单价": "price",
            "金额": "total",
            "添置时间": "createTime",
            "注销时间": "deleteTime",
            "保管人": "admin",
            "备注": "mark"
        }
        var table = [
            ["建筑物", "楼层", "房间"]
        ]
        var total = 0
        table.push([architecture.type + architecture.index, floor.index, room.index])
        table.push([])
        table.push(tableHead)
        for (d of data) {
            total += d.total
            let json = []
            for (let index of tableHead) {
                json.push(d[map[index]])
            }
            table.push(json)
        }
        table.push(['', '', '', '', '', '', '', "累计:", total + "元"])
        return table
    }

    function downloadExl() {
        var architecture = JSON.parse(window.localStorage.getItem("architecture"))
        var floor = JSON.parse(window.localStorage.getItem("floor"))
        var room = JSON.parse(window.localStorage.getItem('room'))
        const wb = {
            SheetNames: ['Sheet1'],
            Sheets: {},
            Props: {}
        };
        data = XLSX.utils.aoa_to_sheet(fix(data));
        wb.Sheets['Sheet1'] = data //通过json_to_sheet转成单页(Sheet)数据

        saveAs(new Blob([s2ab(XLSX.write(wb, wopts))], {
            type: "application/octet-stream"
        }), `${architecture.type}${architecture.index}楼-${floor.index}层-${room.index}房间物品` + '.' + (wopts.bookType ==
            "biff2" ? "xls" : wopts.bookType));
        ipc.send('exportTable', {})

    }

    function s2ab(s) {
        if (typeof ArrayBuffer !== 'undefined') {
            var buf = new ArrayBuffer(s.length);
            var view = new Uint8Array(buf);
            for (var i = 0; i != s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
            return buf;
        } else {
            var buf = new Array(s.length);
            for (var i = 0; i != s.length; ++i) buf[i] = s.charCodeAt(i) & 0xFF;
            return buf;
        }
    }
</script>

</html>